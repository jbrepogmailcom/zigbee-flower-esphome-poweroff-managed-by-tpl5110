substitutions:
  logger_baud: "115200"
  post_report_awake_time: 100ms
  join_timeout_ms: "120000"

esphome:
  name: nrf52840-zigbee-tof
  friendly_name: nRF52840 Zigbee ToF
  on_boot:
    priority: 700
    then:
      - output.turn_off: tpl_done
      - output.turn_on: led_red
      - output.turn_off: led_green
      - output.turn_off: led_blue
      - delay: 200ms
      - output.turn_off: led_red
      - output.turn_on: led_green
      - output.turn_off: led_blue
      - delay: 200ms
      - output.turn_off: led_red
      - output.turn_off: led_green
      - output.turn_on: led_blue
      - delay: 200ms
      - output.turn_off: led_red
      - output.turn_off: led_green
      - output.turn_off: led_blue
      - lambda: |-
          id(boot_ms) = millis();
      - delay: 1s
      - script.execute: ensure_join_or_pair

nrf52:
  board: xiao_ble

logger:
  baud_rate: ${logger_baud}
  level: DEBUG

zigbee:
  power_source: BATTERY
  wipe_on_boot: false

preferences:
  flash_write_interval: never

output:
  - platform: gpio
    id: led_red
    pin:
      number: P0.26
      inverted: true
  - platform: gpio
    id: led_green
    pin:
      number: P0.30
      inverted: true
  - platform: gpio
    id: led_blue
    pin:
      number: P0.06
      inverted: true
  - platform: gpio
    id: tpl_done
    pin:
      number: P1.12
      inverted: false

globals:
  - id: first_measure_done
    type: bool
    restore_value: no
    initial_value: "false"
  - id: boot_ms
    type: uint32_t
    restore_value: no
    initial_value: "0"
  - id: blue_blink_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: measure_in_progress
    type: bool
    restore_value: no
    initial_value: "false"

i2c:
  sda: P1.13
  scl: P1.14
  scan: false
  frequency: 100kHz

sensor:
  - platform: vl53l0x
    id: tof
    name: "Distance"
    address: 0x29
    timing_budget: 50ms
    timeout: 100ms
    unit_of_measurement: "mm"
    accuracy_decimals: 1
    update_interval: never
    filters:
      - multiply: 1000.0
      - sliding_window_moving_average:
          window_size: 20
          send_every: 20
          send_first_at: 20

  - platform: adc
    id: batt_v_raw
    pin: P0.02
    update_interval: never

  - platform: template
    id: batt_v
    name: "Battery_Voltage"
    unit_of_measurement: "V"
    update_interval: never
    lambda: |-
      return id(batt_v_raw).state * 6.6327;

  - platform: template
    id: batt_pct
    name: "Battery"
    unit_of_measurement: "%"
    update_interval: never
    lambda: |-
      float v = id(batt_v).state;
      float pct = (v - 2.2f) / (3.0f - 2.2f) * 100.0f;
      if (pct < 0.0f) pct = 0.0f;
      if (pct > 100.0f) pct = 100.0f;
      return pct;

script:
  - id: ensure_join_or_pair
    mode: restart
    then:
      - lambda: |-
          if (!zb_zdo_joined()) {
            ESP_LOGD("pairing", "Not joined, starting Zigbee network steering");
            bdb_start_top_level_commissioning(ZB_BDB_NETWORK_STEERING);
          }

  - id: measure_report_and_shutdown
    mode: single
    then:
      - component.update: batt_v_raw
      - component.update: batt_v
      - component.update: batt_pct
      - repeat:
          count: 20
          then:
            - component.update: tof
            - delay: 100ms
      - logger.log: "TPL5110 shutdown: setting DONE (P1.12) HIGH now"
      - delay: ${post_report_awake_time}
      - lambda: |-
          id(measure_in_progress) = false;
      - output.turn_off: led_green
      - output.turn_on: tpl_done

interval:
  - interval: 200ms
    then:
      - if:
          condition:
            lambda: "return !zb_zdo_joined() && !id(first_measure_done);"
          then:
            - output.turn_on: led_blue
            - delay: 10ms
            - output.turn_off: led_blue
          else:
            - output.turn_off: led_blue

  - interval: 500ms
    then:
      - if:
          condition:
            lambda: "return id(measure_in_progress);"
          then:
            - output.turn_on: led_green
            - delay: 10ms
            - output.turn_off: led_green
          else:
            - output.turn_off: led_green

  - interval: 5s
    then:
      - if:
          condition:
            lambda: |-
              return !zb_zdo_joined() && !id(first_measure_done) &&
                     (millis() - id(boot_ms) >= ${join_timeout_ms}UL);
          then:
            - output.turn_off: led_blue
            - logger.log: "Join timeout (2min) - shutting down via TPL5110 DONE"
            - delay: 500ms
            - output.turn_on: tpl_done

  - interval: 30s
    then:
      - if:
          condition:
            lambda: "return !zb_zdo_joined() && !id(first_measure_done);"
          then:
            - script.execute: ensure_join_or_pair

  - interval: 1s
    then:
      - if:
          condition:
            lambda: "return zb_zdo_joined() && !id(first_measure_done);"
          then:
            - output.turn_off: led_blue
            - logger.log: "Joined detected - running measurement"
            - lambda: |-
                id(measure_in_progress) = true;
            - script.execute: measure_report_and_shutdown
            - lambda: "id(first_measure_done) = true;"
